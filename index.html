<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>lua compressor</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:      #16161d;
  --panel:   #1e1e27;
  --surface: #252530;
  --line:    #2e2e3a;
  --dim:     #4a4a60;
  --muted:   #7a7a96;
  --text:    #c8c8de;
  --bright:  #eeeef8;
  --accent:  #818cf8;
  --accent2: #a78bfa;
  --green:   #4ade80;
  --amber:   #fbbf24;
  --red:     #f87171;
}

html { font-size: 16px; -webkit-text-size-adjust: 100%; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', sans-serif;
  font-weight: 300;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  padding-left:   env(safe-area-inset-left);
  padding-right:  env(safe-area-inset-right);
  padding-bottom: env(safe-area-inset-bottom);
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: radial-gradient(circle, var(--dim) 1px, transparent 1px);
  background-size: 28px 28px;
  opacity: 0.07;
  pointer-events: none;
  z-index: 0;
}

header {
  position: relative;
  z-index: 1;
  background: var(--panel);
  border-bottom: 1px solid var(--line);
  padding: 0 40px;
  height: 52px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}

.logo-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 8px var(--accent2);
  flex-shrink: 0;
}

.logo {
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 400;
  color: var(--muted);
  letter-spacing: 0.04em;
}
.logo em { font-style: normal; color: var(--bright); font-weight: 500; }

.logo-version {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 400;
  color: var(--accent);
  opacity: 0.6;
  letter-spacing: 0.04em;
}

/* ── main layout ── */
.shell {
  position: relative;
  z-index: 1;
  flex: 1;
  display: flex;
  flex-direction: column;
  max-width: 1200px;
  width: 100%;
  margin: 0 auto;
  padding: 28px 40px 36px;
  gap: 16px;
}

/* ── editor grid ── */
.editors {
  display: grid;
  grid-template-columns: 1fr 1fr;
  border: 1px solid var(--line);
  border-radius: 10px;
  overflow: hidden;
  background: var(--panel);
  box-shadow: 0 2px 16px rgba(0,0,0,0.25);
  transition: border-color 0.2s;
}
.editors.drag-over { border-color: var(--accent); }

.ed {
  display: flex;
  flex-direction: column;
}
.ed:first-child { border-right: 1px solid var(--line); }

.ed-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 9px 14px;
  flex-shrink: 0;
  background: var(--surface);
  border-bottom: 1px solid var(--line);
  gap: 10px;
}

.ed-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--dim);
  user-select: none;
  flex-shrink: 0;
}

.ed-actions { display: flex; gap: 2px; align-items: center; }

.action-btn {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 400;
  color: var(--muted);
  background: none;
  border: 1px solid transparent;
  border-radius: 5px;
  padding: 3px 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: color 0.12s, border-color 0.12s, background 0.12s;
  -webkit-tap-highlight-color: transparent;
  white-space: nowrap;
}
.action-btn:hover    { color: var(--text); border-color: var(--line); background: var(--panel); }
.action-btn:active   { opacity: 0.6; }
.action-btn:disabled { opacity: 0.2; cursor: not-allowed; pointer-events: none; }

textarea {
  flex: 1;
  width: 100%;
  background: var(--panel);
  border: none;
  outline: none;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 300;
  line-height: 1.75;
  padding: 16px 18px 20px;
  resize: none;
  tab-size: 2;
  caret-color: var(--accent);
  -webkit-tap-highlight-color: transparent;
  min-height: 520px;
}
textarea::placeholder { font-style: italic; color: var(--dim); opacity: 0.6; }
textarea.out { color: var(--muted); }
textarea.err { color: var(--red) !important; }

/* ── progress ── */
.progress {
  height: 2px;
  background: transparent;
  overflow: hidden;
  opacity: 0;
  transition: opacity 0.15s;
  flex-shrink: 0;
}
.progress.on { opacity: 1; }
.progress-fill {
  height: 100%;
  width: 0;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ── footer ── */
footer {
  display: flex;
  align-items: center;
  gap: 14px;
  flex-wrap: wrap;
  flex-shrink: 0;
}

.run-btn {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12.5px;
  font-weight: 500;
  color: #0e0e16;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none;
  border-radius: 7px;
  padding: 10px 26px;
  cursor: pointer;
  transition: opacity 0.15s, transform 0.1s, box-shadow 0.15s;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
  min-height: 40px;
  letter-spacing: 0.03em;
  box-shadow: 0 2px 12px rgba(129,140,248,0.2);
}
.run-btn:hover        { opacity: 0.9; box-shadow: 0 4px 20px rgba(129,140,248,0.35); transform: translateY(-1px); }
.run-btn:active       { transform: scale(0.97) translateY(0); box-shadow: none; }
.run-btn:disabled     { opacity: 0.35; cursor: not-allowed; transform: none; box-shadow: none; }
.run-btn.rate-limited { background: var(--surface); color: var(--muted); cursor: not-allowed; box-shadow: none; border: 1px solid var(--line); }

/* ── stats ── */
.stats {
  display: flex;
  border: 1px solid var(--line);
  border-radius: 7px;
  overflow: hidden;
  background: var(--surface);
}
.stat {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 8px 16px;
  border-right: 1px solid var(--line);
}
.stat:last-child { border-right: none; }
.stat-k {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  font-weight: 500;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--dim);
}
.stat-v {
  font-family: 'JetBrains Mono', monospace;
  font-size: 13.5px;
  font-weight: 400;
  color: var(--text);
}
.stat-v.g { color: var(--green); }
.stat-v.a { color: var(--amber); }

/* ── info bar ── */
.info-bar {
  position: relative;
  z-index: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  padding: 0 40px;
  height: 44px;
  background: var(--panel);
  border-top: 1px solid var(--line);
  flex-shrink: 0;
}

.info-item {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--dim);
  display: flex;
  align-items: center;
  gap: 6px;
  letter-spacing: 0.02em;
}

.info-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: var(--accent);
  opacity: 0.5;
}

.info-sep {
  color: var(--line);
  font-size: 13px;
  user-select: none;
}

kbd {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--muted);
  background: var(--surface);
  border: 1px solid var(--line);
  border-radius: 3px;
  padding: 1px 5px;
  line-height: 1.6;
}

@media (max-width: 700px) {
  header    { padding: 0 20px; }
  .shell    { padding: 20px 20px 36px; gap: 12px; }
  .editors  { grid-template-columns: 1fr; flex: none; }
  .ed:first-child { border-right: none; border-bottom: 1px solid var(--line); }
  textarea  { min-height: 300px; font-size: 12.5px; }
  footer    { flex-direction: column; align-items: flex-start; }
}

@media (max-width: 380px) {
  header { padding: 0 14px; }
  .shell { padding: 16px 14px 28px; }
  textarea { font-size: 12px; }
}
</style>
</head>
<body>

<header>
  <div class="logo-dot"></div>
  <div class="logo"><em>lua</em> compressor</div>
  <span class="logo-version">v2.0</span>
</header>

<div class="shell">

  <div class="editors" id="drop-zone">
    <div class="ed">
      <div class="ed-top">
        <span class="ed-label" id="input-label">input</span>
        <div class="ed-actions">
          <button class="action-btn" id="preview-btn" onclick="togglePreview()" disabled>preview stripped</button>
          <button class="action-btn" onclick="triggerUpload()">
            <svg width="9" height="9" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 7V2m-2.5 2L5 2l2.5 2M1 9h8"/>
            </svg>
            upload
          </button>
        </div>
      </div>
      <textarea id="input-lua" placeholder="paste lua source or drop a file" oninput="resetOutput()"></textarea>
    </div>
    <div class="ed">
      <div class="ed-top">
        <span class="ed-label">output</span>
        <div class="ed-actions">
          <button class="action-btn" id="dl-btn" onclick="doDownload()" disabled>
            <svg width="9" height="9" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 3v5m2.5-2L5 8l-2.5-2M1 9h8"/>
            </svg>
            download
          </button>
        </div>
      </div>
      <textarea id="output-compressed" class="out" readonly placeholder="compressed output appears here"></textarea>
    </div>
  </div>

  <div class="progress" id="prog"><div class="progress-fill" id="pf"></div></div>

  <footer>
    <button class="run-btn" id="run-btn" onclick="doCompress()">compress</button>
    <div class="stats" id="stats" style="display:none">
      <div class="stat"><span class="stat-k">original</span><span class="stat-v" id="s-orig"></span></div>
      <div class="stat"><span class="stat-k">compressed</span><span class="stat-v" id="s-comp"></span></div>
      <div class="stat"><span class="stat-k">saved</span><span class="stat-v" id="s-ratio"></span></div>
      <div class="stat"><span class="stat-k">time</span><span class="stat-v" id="s-time"></span></div>
    </div>
  </footer>

</div>

<div class="info-bar">
  <span class="info-item"><span class="info-dot"></span>lzw compression</span>
  <span class="info-sep">·</span>
  <span class="info-item">base&#8209;89 encoding</span>
  <span class="info-sep">·</span>
  <span class="info-item">strips comments</span>
</div>

<input type="file" id="file-input" accept=".lua,.luau,.txt" style="display:none" onchange="handleFile(event)">

<script>
const ALPHA = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!#$%&()*+,-.[:;<=>?@^_]{|}~';
const BASE  = 89;
const enc   = new TextEncoder();

function bitrev16(v) {
  let r = 0;
  for (let i = 0; i < 16; i++) { r = (r << 1) | (v & 1); v >>= 1; }
  return r;
}

function enc3(v) {
  v = bitrev16(v);
  return ALPHA[v % BASE] +
         ALPHA[Math.floor(v / BASE) % BASE] +
         ALPHA[Math.floor(v / (BASE * BASE))];
}

function lzwEncode(input) {
  const bytes = enc.encode(input);
  const N = bytes.length;
  if (N === 0) return '';

  const nodeCodes = new Uint16Array(N + 512);
  for (let f = 0; f <= 255; f++) nodeCodes[f] = f;

  const trie = new Map();
  for (let b = 0; b < 256; b++) trie.set(b, b);

  let nextId = 256, h = 0, i = 1;
  const out = new Uint32Array(N + 1);
  let outLen = 0, dynKeys = [];

  function add(pid, byte, h_, i_) {
    if (h_ > 255) { h_ = 0; i_++; if (i_ > 255) {
      for (const k of dynKeys) trie.delete(k);
      dynKeys = []; nextId = 256; i_ = 1;
    }}
    const id = nextId++, k = pid * 256 + byte;
    trie.set(k, id); dynKeys.push(k);
    nodeCodes[id] = (i_ << 8) | h_;
    return [id, h_ + 1, i_];
  }

  let cur = -1;
  for (let idx = 0; idx < N; idx++) {
    const b = bytes[idx];
    const child = cur < 0 ? b : trie.get(cur * 256 + b);
    if (child !== undefined) { cur = child; continue; }
    out[outLen++] = nodeCodes[cur < 0 ? 0 : cur];
    [, h, i] = add(cur < 0 ? b : cur, b, h, i);
    cur = b;
  }
  if (cur >= 0) out[outLen++] = nodeCodes[cur];

  let payload = '';
  for (let idx = 0; idx < outLen; idx++) payload += enc3(out[idx]);
  return payload;
}

function wrapInLoader(payload) {
  const A = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!#$%&()*+,-.[:;<=>?@^_]{|}~';
  return 'return(function(a,s,m)local A=\'' + A + '\'local T={}for i=1,#A do T[A:byte(i)]=i-1 end for i=0,255 do a[i]=string.char(i)end local g,c,J,t,pv={},256,{},1 local function D(v)if c>65535 then g={}c=256 end g[c]=v c=c+1 end local function R(v)local r=0 for i=1,16 do r=r+r+v%2 v=m(v/2)end return r end local E=\'' + payload + '\'for o=1,#E,3 do local q,w,e=E:byte(o,o+2)local nq=R(T[q]+T[w]*89+T[e]*7921)local ne=a[nq]or g[nq]if pv then local y=pv if ne then J[t]=ne t=t+1 D(y..s(ne,1,1))else local w=y..s(y,1,1)J[t]=w t=t+1 D(w)ne=w end else J[t]=ne t=t+1 end pv=ne end loadstring(table.concat(J))()end)({},string.sub,math.floor)';
}

const RATE_LIMIT = 5;
const RATE_WINDOW = 60_000;
let timestamps = [];
let cooldownTimer = null;

function updateBtn() {
  const now = Date.now();
  timestamps = timestamps.filter(t => now - t < RATE_WINDOW);
  const btn = document.getElementById('run-btn');
  if (timestamps.length >= RATE_LIMIT) {
    const secsLeft = Math.ceil((RATE_WINDOW - (now - timestamps[0])) / 1000);
    btn.textContent = `wait ${secsLeft}s`;
    btn.classList.add('rate-limited');
    btn.disabled = true;
    if (!cooldownTimer) {
      cooldownTimer = setInterval(() => {
        const n = Date.now();
        timestamps = timestamps.filter(t => n - t < RATE_WINDOW);
        if (timestamps.length < RATE_LIMIT) {
          clearInterval(cooldownTimer);
          cooldownTimer = null;
          btn.textContent = 'compress';
          btn.classList.remove('rate-limited');
          btn.disabled = false;
        } else {
          btn.textContent = `wait ${Math.ceil((RATE_WINDOW - (n - timestamps[0])) / 1000)}s`;
        }
      }, 500);
    }
    return false;
  }
  return true;
}

let uploadedFilename = null;

let previewMode = false;
let savedInput = '';

function togglePreview() {
  const ta = document.getElementById('input-lua');
  const btn = document.getElementById('preview-btn');
  const label = document.getElementById('input-label');

  if (!previewMode) {
    const raw = ta.value;
    if (!raw.trim()) return;
    savedInput = raw;
    ta.value = removeLuaComments(raw);
    ta.readOnly = true;
    ta.classList.add('out');
    btn.textContent = 'back to source';
    label.textContent = 'stripped';
    previewMode = true;
  } else {
    ta.value = savedInput;
    ta.readOnly = false;
    ta.classList.remove('out');
    btn.textContent = 'preview stripped';
    label.textContent = 'input';
    previewMode = false;
    savedInput = '';
  }
}

function resetOutput() {
  if (previewMode) {
    const ta = document.getElementById('input-lua');
    const btn = document.getElementById('preview-btn');
    const label = document.getElementById('input-label');
    ta.readOnly = false;
    ta.classList.remove('out');
    btn.textContent = 'preview stripped';
    label.textContent = 'input';
    previewMode = false;
    savedInput = '';
  }
  const outEl = document.getElementById('output-compressed');
  outEl.value = '';
  outEl.classList.remove('err');
  document.getElementById('stats').style.display = 'none';
  document.getElementById('dl-btn').disabled = true;
  document.getElementById('preview-btn').disabled = true;
}

function prog(on) {
  const el   = document.getElementById('prog');
  const fill = document.getElementById('pf');
  if (on) {
    el.classList.add('on');
    fill.style.width = '0%';
    requestAnimationFrame(() => fill.style.width = '65%');
  } else {
    fill.style.width = '100%';
    setTimeout(() => { el.classList.remove('on'); fill.style.width = '0%'; }, 320);
  }
}

function fmt(n) {
  if (n < 1024)    return n + ' B';
  if (n < 1048576) return (n / 1024).toFixed(1) + ' KB';
  return (n / 1048576).toFixed(2) + ' MB';
}

function removeLuaComments(code) {
  if (typeof code !== 'string') throw new Error('Input must be a string');
  let result = '', i = 0;
  const len = code.length;
  while (i < len) {
    const char = code[i];
    if (char !== '-' && char !== '"' && char !== "'" && char !== '[' && char !== '`') { result += char; i++; continue; }
    const nextChar = code[i + 1] || '';
    if (char === '`') {
      const r = parseInterpolatedString(code, i, len);
      result += r.content; i = r.endIndex; continue;
    }
    if (char === '"' || char === "'") {
      const r = parseStringFast(code, i, char, len);
      result += r.content; i = r.endIndex; continue;
    }
    if (char === '[') {
      const lb = matchLongBracketFast(code, i, false, len);
      if (lb) { result += lb.content; i = lb.endIndex; continue; }
      result += char; i++; continue;
    }
    if (char === '-' && nextChar === '-') {
      const after = i + 2;
      if (code[after] === '[') {
        const lb = matchLongBracketFast(code, after, true, len);
        if (lb) { i = lb.endIndex; if (code[i] === '\n') result += '\n', i++; continue; }
      }
      while (i < len && code[i] !== '\n') i++;
      if (code[i] === '\n') result += '\n', i++;
      continue;
    }
    result += char; i++;
  }
  return result;
}

function parseStringFast(code, start, quote, len) {
  let out = code[start], i = start + 1;
  while (i < len) {
    const c = code[i];
    if (c === quote) { out += c; i++; break; }
    if (c === '\\' && i + 1 < len) { out += c + code[i + 1]; i += 2; continue; }
    out += c; i++;
  }
  return { content: out, endIndex: i };
}

function parseInterpolatedString(code, start, len) {
  let out = '`', i = start + 1;
  while (i < len) {
    const c = code[i];
    if (c === '`') { out += '`'; i++; break; }
    if (c === '\\' && i + 1 < len) { out += c + code[i + 1]; i += 2; continue; }
    if (c === '{') {
      out += '{'; i++;
      let depth = 1;
      while (i < len && depth > 0) {
        const ec = code[i];
        if (ec === '{') { depth++; out += ec; i++; }
        else if (ec === '}') { depth--; if (depth > 0) out += ec; i++; }
        else if (ec === '"' || ec === "'") { const r = parseStringFast(code, i, ec, len); out += r.content; i = r.endIndex; }
        else if (ec === '`') { const r = parseInterpolatedString(code, i, len); out += r.content; i = r.endIndex; }
        else if (ec === '[') { const lb = matchLongBracketFast(code, i, false, len); if (lb) { out += lb.content; i = lb.endIndex; } else { out += ec; i++; } }
        else if (ec === '-' && code[i + 1] === '-') { const a = i + 2; if (code[a] === '[') { const lb = matchLongBracketFast(code, a, true, len); if (lb) { i = lb.endIndex; continue; } } while (i < len && code[i] !== '\n') i++; }
        else { out += ec; i++; }
      }
      out += '}'; continue;
    }
    out += c; i++;
  }
  return { content: out, endIndex: i };
}

function matchLongBracketFast(code, start, isComment, len) {
  if (code[start] !== '[') return null;
  let i = start + 1, eq = 0;
  while (code[i] === '=') eq++, i++;
  if (code[i] !== '[') return null;
  i++;
  const close = ']' + '='.repeat(eq) + ']';
  const end = code.indexOf(close, i);
  if (end === -1) return null;
  return { content: isComment ? '' : code.slice(start, end + close.length), endIndex: end + close.length };
}

function doCompress() {
  if (!updateBtn()) return;
  const raw = previewMode ? savedInput : document.getElementById('input-lua').value;
  if (!raw.trim()) return;

  timestamps.push(Date.now());
  updateBtn();

  const outEl = document.getElementById('output-compressed');
  outEl.classList.remove('err');
  document.getElementById('dl-btn').disabled = true;
  prog(true);
  const t0 = performance.now();

  setTimeout(() => {
    try {
      const input = removeLuaComments(raw);
      const ub      = enc.encode(raw).length;
      const payload = lzwEncode(input);
      const result  = wrapInLoader(payload);
      prog(false);

      outEl.value = result;
      document.getElementById('dl-btn').disabled = false;
      document.getElementById('preview-btn').disabled = false;

      const r  = parseFloat(((1 - result.length / ub) * 100).toFixed(1));
      const re = document.getElementById('s-ratio');
      document.getElementById('s-orig').textContent = fmt(ub);
      document.getElementById('s-comp').textContent = fmt(result.length);
      re.textContent = (r > 0 ? '−' : '+') + Math.abs(r) + '%';
      re.className   = 'stat-v' + (r > 30 ? ' g' : r > 0 ? '' : ' a');
      document.getElementById('s-time').textContent = (performance.now() - t0).toFixed(1) + ' ms';
      document.getElementById('stats').style.display = 'flex';
    } catch (e) {
      outEl.value = '-- error: ' + e.message;
      outEl.classList.add('err');
      prog(false);
    }
  }, 20);
}

function doDownload() {
  const val = document.getElementById('output-compressed').value;
  if (!val) return;
  const base = uploadedFilename ? uploadedFilename.replace(/\.[^.]+$/, '') : 'output';
  const name = base + '.min.lua';
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(new Blob([val], { type: 'application/octet-stream' })),
    download: name
  });
  a.click();
  URL.revokeObjectURL(a.href);
}

function triggerUpload() { document.getElementById('file-input').click(); }

function validFile(file) {
  return /\.(lua|luau|txt)$/i.test(file.name);
}

function handleFile(e) {
  const file = e.target.files[0];
  if (!file || !validFile(file)) return;
  uploadedFilename = file.name;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById('input-lua').value = ev.target.result;
    resetOutput();
  };
  reader.readAsText(file);
  e.target.value = '';
}

const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover',  e => { e.preventDefault(); dz.classList.add('drag-over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
dz.addEventListener('drop', e => {
  e.preventDefault();
  dz.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (!file || !validFile(file)) return;
  uploadedFilename = file.name;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById('input-lua').value = ev.target.result;
    resetOutput();
  };
  reader.readAsText(file);
});
</script>
</body>
</html>