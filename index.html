<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>lua compressor</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,300;0,400;0,500;1,300&family=IBM+Plex+Sans:wght@300;400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:      #0c0c0e;
  --panel:   #111113;
  --surface: #18181c;
  --line:    #25252b;
  --dim:     #3e3e4e;
  --muted:   #666678;
  --text:    #c2c2d4;
  --bright:  #e8e8f8;
  --accent:  #7b8fff;
  --green:   #52d68a;
  --amber:   #f5a623;
  --red:     #ff6b6b;
}

html { font-size: 17px; -webkit-text-size-adjust: 100%; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'IBM Plex Sans', sans-serif;
  font-weight: 300;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  padding-left:   env(safe-area-inset-left);
  padding-right:  env(safe-area-inset-right);
  padding-bottom: env(safe-area-inset-bottom);
}

header {
  background: var(--panel);
  border-bottom: 1px solid var(--line);
  padding: 0 52px;
  height: 54px;
  display: flex;
  align-items: center;
  flex-shrink: 0;
}

.shell {
  flex: 1;
  display: flex;
  flex-direction: column;
  max-width: 1200px;
  width: 100%;
  margin: 0 auto;
  padding: 48px 52px 84px;
  gap: 40px;
}

.logo {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 15px;
  font-weight: 400;
  color: var(--muted);
  letter-spacing: 0.02em;
}

.logo em {
  font-style: normal;
  color: var(--bright);
}



.editors {
  display: grid;
  grid-template-columns: 1fr 1fr;
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: 10px;
  overflow: hidden;
  transition: border-color 0.2s;
}

.editors.drag-over { border-color: var(--accent); }

.ed {
  display: flex;
  flex-direction: column;
  min-width: 0;
  background: var(--panel);
}

.ed:first-child { border-right: 1px solid var(--line); }

.ed-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px 12px;
  flex-shrink: 0;
  border-bottom: 1px solid var(--line);
}

.ed-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: var(--dim);
  user-select: none;
}

.upload-btn {
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 12.5px;
  font-weight: 300;
  color: var(--dim);
  background: none;
  border: none;
  padding: 2px 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: color 0.12s;
  -webkit-tap-highlight-color: transparent;
}
.upload-btn:hover  { color: var(--muted); }
.upload-btn:active { opacity: 0.5; }
.upload-btn:disabled { opacity: 0.25; cursor: not-allowed; pointer-events: none; }

textarea {
  flex: 1;
  width: 100%;
  min-height: 460px;
  background: var(--surface);
  border: none;
  outline: none;
  color: var(--text);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 14.5px;
  font-weight: 300;
  line-height: 1.8;
  padding: 20px 24px 28px;
  resize: none;
  tab-size: 2;
  caret-color: var(--accent);
  -webkit-tap-highlight-color: transparent;
}

textarea::placeholder { font-style: italic; color: var(--dim); }
textarea.out { color: var(--muted); }
textarea.err { color: var(--red) !important; }

.progress {
  height: 1px;
  background: var(--line);
  overflow: hidden;
  opacity: 0;
  transition: opacity 0.2s;
}
.progress.on { opacity: 1; }
.progress-fill {
  height: 100%;
  width: 0;
  background: var(--accent);
  transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

footer {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 16px;
}

.run-btn {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 13.5px;
  font-weight: 400;
  color: var(--bg);
  background: var(--accent);
  border: none;
  border-radius: 6px;
  padding: 11px 26px;
  cursor: pointer;
  transition: opacity 0.15s, transform 0.1s;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
  min-height: 44px;
}
.run-btn:hover          { opacity: 0.85; }
.run-btn:active         { transform: scale(0.97); }
.run-btn:disabled       { opacity: 0.4; cursor: not-allowed; transform: none; }
.run-btn.rate-limited   { background: var(--dim); color: var(--muted); cursor: not-allowed; }

.stats {
  display: flex;
  align-items: stretch;
  gap: 0;
  flex-wrap: wrap;
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: 8px;
  overflow: hidden;
}

.stat {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 12px 20px;
  border-right: 1px solid var(--line);
}

.stat:last-child { border-right: none; }

.stat-k {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9.5px;
  font-weight: 500;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--dim);
}

.stat-v {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 15px;
  font-weight: 300;
  color: var(--text);
}

.stat-v.g { color: var(--green); }
.stat-v.a { color: var(--amber); }

@media (max-width: 680px) {
  header   { padding: 0 24px; }
  .shell   { padding: 36px 24px 56px; gap: 26px; }
  .editors { grid-template-columns: 1fr; }
  .ed:first-child { border-right: none; border-bottom: 1px solid var(--line); }
  textarea { min-height: 240px; font-size: 15px; }
  .run-btn { font-size: 15px; padding: 13px 26px; }
}

@media (max-width: 400px) {
  header { padding: 0 18px; }
  .shell { padding: 28px 18px 44px; }
  textarea { font-size: 14px; }
}
</style>
</head>
<body>

<header>
  <div class="logo"><em>lua</em> compressor</div>
</header>

<div class="shell">

  <div class="progress" id="prog"><div class="progress-fill" id="pf"></div></div>

  <div class="editors" id="drop-zone">
    <div class="ed">
      <div class="ed-top">
        <span class="ed-label" id="input-label">input</span>
        <div style="display:flex;gap:14px;align-items:center">
          <button class="upload-btn" id="preview-btn" onclick="togglePreview()">preview stripped</button>
          <button class="upload-btn" onclick="triggerUpload()">
            <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 7V2m-2.5 2L5 2l2.5 2M1 9h8"/>
            </svg>
            upload
          </button>
        </div>
      </div>
      <textarea id="input-lua" placeholder="paste lua source or drop a file" oninput="resetOutput()"></textarea>
    </div>

    <div class="ed">
      <div class="ed-top">
        <span class="ed-label">output</span>
        <button class="upload-btn" id="dl-btn" onclick="doDownload()" disabled>
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 3v5m2.5-2L5 8l-2.5-2M1 9h8"/>
          </svg>
          download
        </button>
      </div>
      <textarea id="output-compressed" class="out" readonly placeholder="compressed output appears here"></textarea>
    </div>
  </div>

  <footer>
    <button class="run-btn" id="run-btn" onclick="doCompress()">compress</button>
    <div class="stats" id="stats" style="display:none">
      <div class="stat"><span class="stat-k">original</span><span class="stat-v" id="s-orig"></span></div>
      <div class="stat"><span class="stat-k">compressed</span><span class="stat-v" id="s-comp"></span></div>
      <div class="stat"><span class="stat-k">saved</span><span class="stat-v" id="s-ratio"></span></div>
      <div class="stat"><span class="stat-k">time</span><span class="stat-v" id="s-time"></span></div>
    </div>
  </footer>

</div>

<input type="file" id="file-input" accept=".lua,.luau,.txt" style="display:none" onchange="handleFile(event)">

<script>
const ALPHA = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!#$%&()*+,-.[:;<=>?@^_]{|}~';
const BASE  = 89;
const enc   = new TextEncoder();

function bitrev16(v) {
  let r = 0;
  for (let i = 0; i < 16; i++) { r = (r << 1) | (v & 1); v >>= 1; }
  return r;
}

function enc3(v) {
  v = bitrev16(v);
  return ALPHA[v % BASE] +
         ALPHA[Math.floor(v / BASE) % BASE] +
         ALPHA[Math.floor(v / (BASE * BASE))];
}

function lzwEncode(input) {
  const bytes = enc.encode(input);
  const N = bytes.length;
  if (N === 0) return '';

  const nodeCodes = new Uint16Array(N + 512);
  for (let f = 0; f <= 255; f++) nodeCodes[f] = f;

  const trie = new Map();
  for (let b = 0; b < 256; b++) trie.set(b, b);

  let nextId = 256, h = 0, i = 1;
  const out = new Uint32Array(N + 1);
  let outLen = 0, dynKeys = [];

  function add(pid, byte, h_, i_) {
    if (h_ > 255) { h_ = 0; i_++; if (i_ > 255) {
      for (const k of dynKeys) trie.delete(k);
      dynKeys = []; nextId = 256; i_ = 1;
    }}
    const id = nextId++, k = pid * 256 + byte;
    trie.set(k, id); dynKeys.push(k);
    nodeCodes[id] = (i_ << 8) | h_;
    return [id, h_ + 1, i_];
  }

  let cur = -1;
  for (let idx = 0; idx < N; idx++) {
    const b = bytes[idx];
    const child = cur < 0 ? b : trie.get(cur * 256 + b);
    if (child !== undefined) { cur = child; continue; }
    out[outLen++] = nodeCodes[cur < 0 ? 0 : cur];
    [, h, i] = add(cur < 0 ? b : cur, b, h, i);
    cur = b;
  }
  if (cur >= 0) out[outLen++] = nodeCodes[cur];

  let payload = '';
  for (let idx = 0; idx < outLen; idx++) payload += enc3(out[idx]);
  return payload;
}

function wrapInLoader(payload) {
  const A = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!#$%&()*+,-.[:;<=>?@^_]{|}~';
  return 'return(function(a,s,m)local A=\'' + A + '\'local T={}for i=1,#A do T[A:byte(i)]=i-1 end for i=0,255 do a[i]=string.char(i)end local g,c,J,t,pv={},256,{},1 local function D(v)if c>65535 then g={}c=256 end g[c]=v c=c+1 end local function R(v)local r=0 for i=1,16 do r=r+r+v%2 v=m(v/2)end return r end local E=\'' + payload + '\'for o=1,#E,3 do local q,w,e=E:byte(o,o+2)local nq=R(T[q]+T[w]*89+T[e]*7921)local ne=a[nq]or g[nq]if pv then local y=pv if ne then J[t]=ne t=t+1 D(y..s(ne,1,1))else local w=y..s(y,1,1)J[t]=w t=t+1 D(w)ne=w end else J[t]=ne t=t+1 end pv=ne end loadstring(table.concat(J))()end)({},string.sub,math.floor)';
}

const RATE_LIMIT = 5;
const RATE_WINDOW = 60_000;
let timestamps = [];
let cooldownTimer = null;

function updateBtn() {
  const now = Date.now();
  timestamps = timestamps.filter(t => now - t < RATE_WINDOW);
  const btn = document.getElementById('run-btn');
  if (timestamps.length >= RATE_LIMIT) {
    const secsLeft = Math.ceil((RATE_WINDOW - (now - timestamps[0])) / 1000);
    btn.textContent = `wait ${secsLeft}s`;
    btn.classList.add('rate-limited');
    btn.disabled = true;
    if (!cooldownTimer) {
      cooldownTimer = setInterval(() => {
        const n = Date.now();
        timestamps = timestamps.filter(t => n - t < RATE_WINDOW);
        if (timestamps.length < RATE_LIMIT) {
          clearInterval(cooldownTimer);
          cooldownTimer = null;
          btn.textContent = 'compress';
          btn.classList.remove('rate-limited');
          btn.disabled = false;
        } else {
          btn.textContent = `wait ${Math.ceil((RATE_WINDOW - (n - timestamps[0])) / 1000)}s`;
        }
      }, 500);
    }
    return false;
  }
  return true;
}

let uploadedFilename = null;

let previewMode = false;
let savedInput = '';

function togglePreview() {
  const ta = document.getElementById('input-lua');
  const btn = document.getElementById('preview-btn');
  const label = document.getElementById('input-label');

  if (!previewMode) {
    const raw = ta.value;
    if (!raw.trim()) return;
    savedInput = raw;
    ta.value = removeLuaComments(raw);
    ta.readOnly = true;
    ta.classList.add('out');
    btn.textContent = 'back to source';
    label.textContent = 'stripped';
    previewMode = true;
  } else {
    ta.value = savedInput;
    ta.readOnly = false;
    ta.classList.remove('out');
    btn.textContent = 'preview stripped';
    label.textContent = 'input';
    previewMode = false;
    savedInput = '';
  }
}

function resetOutput() {
  if (previewMode) {
    const ta = document.getElementById('input-lua');
    const btn = document.getElementById('preview-btn');
    const label = document.getElementById('input-label');
    ta.readOnly = false;
    ta.classList.remove('out');
    btn.textContent = 'preview stripped';
    label.textContent = 'input';
    previewMode = false;
    savedInput = '';
  }
  const outEl = document.getElementById('output-compressed');
  outEl.value = '';
  outEl.classList.remove('err');
  document.getElementById('stats').style.display = 'none';
  document.getElementById('dl-btn').disabled = true;
}

function prog(on) {
  const el   = document.getElementById('prog');
  const fill = document.getElementById('pf');
  if (on) {
    el.classList.add('on');
    fill.style.width = '0%';
    requestAnimationFrame(() => fill.style.width = '65%');
  } else {
    fill.style.width = '100%';
    setTimeout(() => { el.classList.remove('on'); fill.style.width = '0%'; }, 320);
  }
}

function fmt(n) {
  if (n < 1024)    return n + ' B';
  if (n < 1048576) return (n / 1024).toFixed(1) + ' KB';
  return (n / 1048576).toFixed(2) + ' MB';
}

function removeLuaComments(code) {
  if (typeof code !== 'string') throw new Error('Input must be a string');
  let result = '', i = 0;
  const len = code.length;
  while (i < len) {
    const char = code[i];
    if (char !== '-' && char !== '"' && char !== "'" && char !== '[' && char !== '`') { result += char; i++; continue; }
    const nextChar = code[i + 1] || '';
    if (char === '`') {
      const r = parseInterpolatedString(code, i, len);
      result += r.content; i = r.endIndex; continue;
    }
    if (char === '"' || char === "'") {
      const r = parseStringFast(code, i, char, len);
      result += r.content; i = r.endIndex; continue;
    }
    if (char === '[') {
      const lb = matchLongBracketFast(code, i, false, len);
      if (lb) { result += lb.content; i = lb.endIndex; continue; }
      result += char; i++; continue;
    }
    if (char === '-' && nextChar === '-') {
      const after = i + 2;
      if (code[after] === '[') {
        const lb = matchLongBracketFast(code, after, true, len);
        if (lb) { i = lb.endIndex; if (code[i] === '\n') result += '\n', i++; continue; }
      }
      while (i < len && code[i] !== '\n') i++;
      if (code[i] === '\n') result += '\n', i++;
      continue;
    }
    result += char; i++;
  }
  return result;
}

function parseStringFast(code, start, quote, len) {
  let out = code[start], i = start + 1;
  while (i < len) {
    const c = code[i];
    if (c === quote) { out += c; i++; break; }
    if (c === '\\' && i + 1 < len) { out += c + code[i + 1]; i += 2; continue; }
    out += c; i++;
  }
  return { content: out, endIndex: i };
}

function parseInterpolatedString(code, start, len) {
  let out = '`', i = start + 1;
  while (i < len) {
    const c = code[i];
    if (c === '`') { out += '`'; i++; break; }
    if (c === '\\' && i + 1 < len) { out += c + code[i + 1]; i += 2; continue; }
    if (c === '{') {
      out += '{'; i++;
      let depth = 1;
      while (i < len && depth > 0) {
        const ec = code[i];
        if (ec === '{') { depth++; out += ec; i++; }
        else if (ec === '}') { depth--; if (depth > 0) out += ec; i++; }
        else if (ec === '"' || ec === "'") { const r = parseStringFast(code, i, ec, len); out += r.content; i = r.endIndex; }
        else if (ec === '`') { const r = parseInterpolatedString(code, i, len); out += r.content; i = r.endIndex; }
        else if (ec === '[') { const lb = matchLongBracketFast(code, i, false, len); if (lb) { out += lb.content; i = lb.endIndex; } else { out += ec; i++; } }
        else if (ec === '-' && code[i + 1] === '-') { const a = i + 2; if (code[a] === '[') { const lb = matchLongBracketFast(code, a, true, len); if (lb) { i = lb.endIndex; continue; } } while (i < len && code[i] !== '\n') i++; }
        else { out += ec; i++; }
      }
      out += '}'; continue;
    }
    out += c; i++;
  }
  return { content: out, endIndex: i };
}

function matchLongBracketFast(code, start, isComment, len) {
  if (code[start] !== '[') return null;
  let i = start + 1, eq = 0;
  while (code[i] === '=') eq++, i++;
  if (code[i] !== '[') return null;
  i++;
  const close = ']' + '='.repeat(eq) + ']';
  const end = code.indexOf(close, i);
  if (end === -1) return null;
  return { content: isComment ? '' : code.slice(start, end + close.length), endIndex: end + close.length };
}

function doCompress() {
  if (!updateBtn()) return;
  const raw = previewMode ? savedInput : document.getElementById('input-lua').value;
  if (!raw.trim()) return;

  timestamps.push(Date.now());
  updateBtn();

  const outEl = document.getElementById('output-compressed');
  outEl.classList.remove('err');
  document.getElementById('dl-btn').disabled = true;
  prog(true);
  const t0 = performance.now();

  setTimeout(() => {
    try {
      const input = removeLuaComments(raw);
      const ub      = enc.encode(raw).length;
      const payload = lzwEncode(input);
      const result  = wrapInLoader(payload);
      prog(false);

      outEl.value = result;
      document.getElementById('dl-btn').disabled = false;

      const r  = parseFloat(((1 - result.length / ub) * 100).toFixed(1));
      const re = document.getElementById('s-ratio');
      document.getElementById('s-orig').textContent = fmt(ub);
      document.getElementById('s-comp').textContent = fmt(result.length);
      re.textContent = (r > 0 ? 'âˆ’' : '+') + Math.abs(r) + '%';
      re.className   = 'stat-v' + (r > 30 ? ' g' : r > 0 ? '' : ' a');
      document.getElementById('s-time').textContent = (performance.now() - t0).toFixed(1) + ' ms';
      document.getElementById('stats').style.display = 'flex';
    } catch (e) {
      outEl.value = '-- error: ' + e.message;
      outEl.classList.add('err');
      prog(false);
    }
  }, 20);
}

function doDownload() {
  const val = document.getElementById('output-compressed').value;
  if (!val) return;
  const base = uploadedFilename ? uploadedFilename.replace(/\.[^.]+$/, '') : 'output';
  const name = base + '.min.lua';
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(new Blob([val], { type: 'application/octet-stream' })),
    download: name
  });
  a.click();
  URL.revokeObjectURL(a.href);
}

function triggerUpload() { document.getElementById('file-input').click(); }

function validFile(file) {
  return /\.(lua|luau|txt)$/i.test(file.name);
}

function handleFile(e) {
  const file = e.target.files[0];
  if (!file || !validFile(file)) return;
  uploadedFilename = file.name;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById('input-lua').value = ev.target.result;
    resetOutput();
  };
  reader.readAsText(file);
  e.target.value = '';
}

const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover',  e => { e.preventDefault(); dz.classList.add('drag-over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
dz.addEventListener('drop', e => {
  e.preventDefault();
  dz.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (!file || !validFile(file)) return;
  uploadedFilename = file.name;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById('input-lua').value = ev.target.result;
    resetOutput();
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
